
<canvas id="canvas" width="400" height="400"></canvas>
<script>

let canvas = document.getElementById('canvas'),
context = canvas.getContext('2d'),imageData;

let image=new Image();
image.crossOrigin="Anonymous";
image.src="https://i.imgur.com/nOh40PS.png";
image.onload=function(){
	context.drawImage(image,0,0,400,400);
    
    
    
    //let imageData = context.getImageData(240, 240, 50, 50);
    let imageData = context.getImageData(0, 50, 50, 50);
    //context.clearRect(0, 0, 400, 400);
	//context.putImageData(imageData,0,0);
    //console.log(imageData.data.length);
    
    let xArr=[],yArr=[];
    let x=-1,y=0;
    for(let i=0;i<imageData.data.length;i+=4){
    	if(i%200===0){
        	x=0;
            y=i%199;
        }
        else
        x++;
		//console.log(imageData.data[i]);
        if(imageData.data[i]>50){
        	xArr.push(x);
            yArr.push(49-y);
            
        }
       
    }
    console.log(yArr);
    console.log(xArr);
   console.log(linearRegression(yArr,xArr));
    //context.putImageData(imageData,0,0);
    
   
    subgridDivision(50,50,canvas);
}


function subgridDivision(subgridWidth,subgridHeight,canvasElement){
	let noSubgridX=(canvasElement.width/subgridWidth)<<0,
    noSubgridY=(canvasElement.height/subgridHeight)<<0,
	noSubgridPixelY=subgridWidth*4,//4 represent rgba
    context=canvasElement.getContext('2d'),
    imageData,
    xArr=[],yArr=[],
    currentX=-1,currentY=0,
    results=[];
    console.log(noSubgridY);
    
    //make outline black color
    context.fillStyle = "#000000";
	context.fillRect(0, 0, canvasElement.width, 1);
	context.fillRect(0, 0, 1, canvasElement.height);
    context.fillRect(canvasElement.width-1, 0, 1, canvasElement.height);
    context.fillRect(0, canvasElement.height-1, canvasElement.width, 1);
    
    for(let y=0;y<noSubgridY;y++){
    	for(let x=0;x<noSubgridX;x++){
        	imageData = context.getImageData(x*subgridWidth, y*subgridHeight, subgridWidth, subgridHeight);
            console.log(imageData.data.length);
            //context.fillStyle = "#FF0000";
		//context.fillRect(x*subgridWidth, y*subgridHeight, 50, 50);
            xArr=[];
            yArr=[];
            for(let i=0;i<imageData.data.length;i+=4){
              if(i%noSubgridPixelY===0){
                  currentX=0;
                  currentY=i%(noSubgridPixelY-1);
              }
              else
              currentX++;

              if(imageData.data[i]>0){
                  xArr.push(currentX);
                  yArr.push(subgridWidth-currentY-1);
              }
          	}
            
            let temp=linearRegression(yArr,xArr);
            temp.startXPos=x*subgridWidth;
            temp.startYPos=y*subgridHeight;
            //console.log(xArr,yArr);
            results.push(temp);
            //y=999;
            //break;
          
        }
    }
console.log(results);
    let rr=results.reduce(function(r,value){
    	if(value.r2>0.5)
        r.push(value);
        return r;
    },[]);
    
   console.log(rr);
   rr.forEach(function(elem){
   		context.fillStyle = "#FF0000";
		context.fillRect(elem.startXPos, elem.startYPos, 40, 40);
   });
   
    
}



function linearRegression(y,x){
        var lr = {};
        var n = y.length;
        var sum_x = 0;
        var sum_y = 0;
        var sum_xy = 0;
        var sum_xx = 0;
        var sum_yy = 0;

        for (var i = 0; i < y.length; i++) {
            sum_x += x[i];
            sum_y += y[i];
            sum_xy += (x[i]*y[i]);
            sum_xx += (x[i]*x[i]);
            sum_yy += (y[i]*y[i]);
        } 

        lr.slope = (n * sum_xy - sum_x * sum_y) / (n*sum_xx - sum_x * sum_x);
        if(isNaN(lr.slope)){
        	lr.r2=0;
            lr.intercept=0;
            lr.slope=0;
            lr.angle=0;
        	return lr;
        }
        lr.intercept = (sum_y - lr.slope * sum_x)/n;
        lr.r2 = Math.pow((n*sum_xy - sum_x*sum_y)/Math.sqrt((n*sum_xx-sum_x*sum_x)*(n*sum_yy-sum_y*sum_y)),2);
        
		if(!lr.r2 && lr.intercept)lr.r2=0.9;
        
        let temp_x=5,temp_y=lr.slope*5;
        lr.angle=Math.atan2(temp_y, temp_x) * 180 / Math.PI;
		
        
        return lr;
}

</script>
